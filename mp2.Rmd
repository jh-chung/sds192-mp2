---
title: "Mini-Project 2"
author: "Brigitte Goeler-Slough, Jay-Ho Chung, and Nathan Ives"
date: "March 19, 2018"
output:
  html_document:
    code_folding: hide
---

```{r (Loading our Packages), message = FALSE, warning= FALSE}
library(tidyverse)
library(ggthemes)
library(gridExtra)
library(dplyr)
library(ggplot2)
```

```{r (Loading the Dataset), include=FALSE}
load("house_elections.rda")
load("candidates.rda")
load("committees.rda")
load("contributions.rda")
```

```{r (Data Wrangling: Merging "candidates", "house_elections" , and "contributions)}
# This was our initial step to join the contributions and candidates datasets, along with  h_elections as well. This was helpful to us for the rest of the assignment
cand_contributions <- contributions %>%
  full_join(candidates , by = "cand_id") %>%
  group_by(cand_id , cand_name , cand_office_state , cmte_id , transaction_amt , transaction_dt , transaction_pgi , transaction_type)

h_elections <- house_elections %>% 
  rename(cand_id = fec_id) 

hcand_contributions <- cand_contributions %>%
  full_join(h_elections , by = "cand_id") %>%
  select(cand_id , cand_name , cand_office_state , cand_party_affiliation , cand_office_district , cmte_id , transaction_amt , cand_election_yr , transaction_dt , transaction_pgi , transaction_type , entity_type , ge_winner) 
```

```{r (Data Wrangling: Finding Wins)}
# Created hcand_dollars, which modified hcand_contributions
# dataset. The idea was to look at how much money was donated
# per candidate, broken down for each of the parties
hcand_dollars <- hcand_contributions %>% 
  # Filtered out any NA entries for the party or dollar amount
  filter(!is.na(cand_party_affiliation)) %>% 
  filter(!is.na(transaction_amt)) %>% 
  group_by(cand_party_affiliation) %>% 
  # Summarized for the total_donations for each party, the
  # number of candidates for each party, and then the amount
  # donated per candidate for each party.
  summarize(total_donations = sum(transaction_amt),
            num_cand = n_distinct(cand_name),
            per_cand = total_donations / num_cand) %>% 
  # filtered by parties
  filter(cand_party_affiliation %in% c("DFL", "DEM", 
                                       "REP","IND"))

# hcand_wins is similar to hcand_dollars, except that we're
# looking at the likelihood of a given candidate winning an
# election based on the party. We then hoped to compare if there
# was any relation between the amount of dollars spent per
# candidate and how likely they were to win depending on the
# party.
hcand_wins <- hcand_contributions %>% 
  filter(!is.na(cand_party_affiliation), !is.na(ge_winner)) %>% 
  ungroup() %>% 
  # Selected by party, name, and result because wanted to make
  # sure we didn't double count at all and didn't need the
  # unnecessary information
  select(cand_party_affiliation, cand_name,
         ge_winner) %>% 
  group_by(cand_name) %>% 
  # Wanted to not look at repeat names
  unique() %>% 
  group_by(cand_party_affiliation) %>% 
  # Summarized by party for the total number of candidates, the
  # number of wins, and the likelihood of winning.
  summarize(total = n_distinct(cand_name), 
            wins = sum(ifelse(ge_winner == "W", 1, 0)),
            prop = wins/total) %>% 
  #similarly filtered by only certain parties
  filter(cand_party_affiliation %in% c("DFL", "DEM", 
                                       "REP", "IND"))
```

These plots include information from joining together the contributions, candidates, and house_elections data sets. On the left, there is information about the success rate of the different parties in elections. On top of each of the bars on the chart is the total number of candidates from the data. So while the Minnesota Democratic-Farmer-Labor Party (or DFL) has a higher success rate than Democrats or Republicans, there were also fewer candidates from this party. The graph on the right shows the amount of donations per candidate separated by party. We were trying to see if there was any correlation between the success of party candidates and the amount of donations they received. One interesting thing that can be seen is that Democrats spent comparatively more than Republicans on each candidate, but had a very similar success rate in elections. Also, as would be expected, Independents do not appear to be very successful.

```{r}
# basic plots showing success of parties in elections,
# as well as total donations received
percent_plot <- ggplot(hcand_wins, aes(x = cand_party_affiliation, y = prop)) +
  geom_bar(stat = "identity", aes(fill = cand_party_affiliation)) +
  labs(title = "Success Rate by Party", x = "Party", y = "Proportion of Wins in Elections") +
  theme_economist() + 
  theme(plot.title = element_text(size = 12),
        legend.position = "none") +
  geom_text(aes(label = total),
            position = position_dodge(width = 0.9),
            vjust = -0.25,
            size = 3)

money_plot <- ggplot(hcand_dollars, 
                     aes(x = cand_party_affiliation, 
                         y = per_cand)) +
  geom_bar(stat = "identity", aes(fill = cand_party_affiliation)) +
  labs(title = "Donations per Candidate",
       subtitle = "Separated by Party",
       x = "Party", y = "Total Dollars Donated") +
  theme_economist() +
  theme(plot.title = element_text(size = 12),
        legend.position = "none")

# Arranging percent_plot and money_plot on same plot
grid.arrange(percent_plot, money_plot, ncol = 2)
```

```{r}
pos_cand_dollars <- hcand_contributions %>%
filter(!is.na(cand_party_affiliation)) %>% 
  filter(!is.na(transaction_amt)) %>% 
# both party affiliation and transaction ammount wer needed in the graph, so I filtered out the entries with na values
  group_by(cand_party_affiliation) %>% 
  mutate(total_donations = sum(transaction_amt),
            num_cand = n_distinct(cand_name),
            per_cand = total_donations / num_cand) %>% 
  filter(cand_party_affiliation %in% c("DFL", "DEM", 
                                       "REP","IND")) %>%
# I filtered out the same parties as the previous graphs, for sake of consistency
  filter(transaction_type == "24E")
# This filter was to just get the positive contributions

neg_cand_dollars <- hcand_contributions %>%
filter(!is.na(cand_party_affiliation)) %>% 
  filter(!is.na(transaction_amt)) %>% 
  group_by(cand_party_affiliation) %>% 
  mutate(total_donations = sum(transaction_amt),
            num_cand = n_distinct(cand_name),
            per_cand = total_donations / num_cand) %>% 
  filter(cand_party_affiliation %in% c("DFL", "DEM", 
                                       "REP","IND")) %>%
  filter(transaction_type == "24A")
# same code as above, just filtering by the negative contributions instead
```

```{r}
contributions_plot <- function(dataset) {
 ggplot(dataset, aes(x = cand_party_affiliation, y = per_cand)) +
    scale_y_continuous(limits = c(0, 65000000000)) +
    theme_economist() +
    geom_bar(stat = "identity", aes(fill = cand_party_affiliation)) +
    theme(plot.title = element_text(size = 9),
          legend.position = "none")+
    labs(x = "Party", y = "Total Dollars")
}
# I made a function so I could easily make the positive and negative graphs without repeating the same code. I also chose to put the same limit on the graphs so it's easier to compare the values in both graphs.

positive_contributions_plot <- contributions_plot(dataset = pos_cand_dollars) + 
  labs(title = "Positive Contributions per Candidates")
negative_contributions_plot <- contributions_plot(dataset = neg_cand_dollars) +
  labs(title = "Negative Contributions per Candidate") 
# The easiest way I found to make the title of the graph different was to add the title to the output of the function

grid.arrange(positive_contributions_plot, negative_contributions_plot, ncol = 2)
# I decided to put the graphs side by side so it's easier to see the comparisons between them
```

```{r}
dfl_money <- hcand_dollars %>%
  filter(cand_party_affiliation == "DFL") %>%
  arrange(desc(transaction_amt)) %>%
  group_by(transaction_type) %>%
  summarise(total_type = sum(transaction_amt)) %>%
  select(total_type, transaction_type) %>%
  arrange(desc(total_type))
# I wanted to see where the funding for the DFL was coming from, if not from positive contributions.

dfl_plot <- ggplot(dfl_money, aes(x = transaction_type, y = total_type)) + 
  geom_bar(stat = "identity", aes(fill = transaction_type)) + 
  theme_economist() +
  theme(legend.position = "none") +
  labs(title = "DFL totals of contribution types")

ind_money <- hcand_dollars %>%
  filter(cand_party_affiliation == "IND") %>%
  arrange(desc(transaction_amt)) %>%
  group_by(transaction_type) %>%
  summarise(total_type = sum(transaction_amt)) %>%
  select(total_type, transaction_type) %>%
  arrange(desc(total_type))
# Same as the DFL, but for the IND party

ind_plot <- ggplot(ind_money, aes(x = transaction_type, y = total_type)) + 
  geom_bar(stat = "identity", aes(fill = transaction_type)) + 
  theme_economist() +
  theme(legend.position = "none") + 
  labs(title = "IND totals of contribution types")

grid.arrange(dfl_plot, ind_plot, ncol = 2)
```

```{r}
Pelection_places <- pos_cand_dollars %>%
  na.omit(ge_winner) %>%
  na.omit(cand_election_yr) %>% 
  group_by(cand_office_state) %>%
  summarize(election_scopes = n_distinct(cand_office_state))

Nelection_places <- neg_cand_dollars %>%
  na.omit(ge_winner) %>%
  na.omit(cand_election_yr) %>% 
  group_by(cand_office_state) %>%
  summarize(election_scopes = n_distinct(cand_office_state))
# Creating our list of States
PofficeStateList <- as.list(Pelection_places$cand_office_state)
NofficeStateList <- as.list(Nelection_places$cand_office_state)

dub_z <- hcand_contributions %>% 
  filter(!is.na(cand_party_affiliation), !is.na(ge_winner)) %>% 
  ungroup() %>% 
  select(cand_party_affiliation, cand_name,
         ge_winner , cand_office_state) %>% 
  group_by(cand_name) %>% 
  unique() %>% 
  group_by(cand_party_affiliation , cand_office_state) %>% 
  summarize(total = n_distinct(cand_name), 
            wins = sum(ifelse(ge_winner == "W", 1, 0)),
            prop = wins/total)


the_winz <- function(state_put) {
  dub_z %>%
  filter(cand_office_state == state_put)
}
```

```{r (Applying Success Rates by Party)}
Ppercent_plot <- function(state_put) {
  ggplot(the_winz(state_put), aes(x = cand_party_affiliation, y = prop)) +
  geom_bar(stat = "identity", aes(fill = cand_party_affiliation)) +
  labs(title = "Success Rate by Party", x = "Party", y = "Proportion of Wins in Elections") +
  theme_economist() + 
  theme(plot.title = element_text(size = 3),
        axis.text.x =  element_text(size = 3) ,
        axis.text.y = element_text(size = 3) ,
        legend.position = "none") +
  geom_text(aes(label = total),
            position = position_dodge(width = 0.9),
            vjust = -0.25,
            size = 3) +
    ggtitle(paste(which(c(PofficeStateList) == state_put), ". " , state_put, sep = ""))
}

AllPDub_z <- lapply(PofficeStateList , FUN = Ppercent_plot) 

do.call("grid.arrange" , c(AllPDub_z , ncol = 3))
```

```{r (Graphing for each state) , fig.width = 30, fig.height=15}
# This finds us were the states where there were positive candidate contributions. 
# Quick note: 24A and 24E were only found in 2012. 

Pelection_places <- pos_cand_dollars %>%
  na.omit(ge_winner) %>%
  na.omit(cand_election_yr) %>% 
  group_by(cand_office_state) %>%
  summarize(election_scopes = n_distinct(cand_office_state))

Nelection_places <- neg_cand_dollars %>%
  na.omit(ge_winner) %>%
  na.omit(cand_election_yr) %>% 
  group_by(cand_office_state) %>%
  summarize(election_scopes = n_distinct(cand_office_state))
# Creating our list of States
PofficeStateList <- as.list(Pelection_places$cand_office_state)
NofficeStateList <- as.list(Nelection_places$cand_office_state)

pos_cand_state <- function(state_put) {
  pos_cand_dollars %>%
  filter(cand_office_state == state_put)
}

neg_cand_state <- function(state_put) {
  neg_cand_dollars %>%
  filter(cand_office_state == state_put)
}

PlistDataset <- lapply(PofficeStateList , FUN = pos_cand_state)

NlistDataset <- lapply(NofficeStateList , FUN = neg_cand_state)
```

```{r , fig.width = 30, fig.height=15}
# So pos_cand_state is out filtered out positive cand state tbls.
Pplot_z <- function(state_put) {
    ggplot(data = pos_cand_state(state_put), aes(x = cand_party_affiliation, y = per_cand)) +
    theme_economist() +
    geom_bar(stat = "identity", aes(fill = cand_party_affiliation)) +
    theme(plot.title = element_text(size = 6) ,
          axis.text.x =  element_text(size = 6) ,
          axis.text.y = element_text(size = 6) ,
          legend.position = "none") +
    labs(x = "Party", y = "Total Dollars") + 
    ggtitle(paste(which(c(PofficeStateList) == state_put), ". " , state_put, sep = ""))
}
# Maybe I want to filer by positive states
Pgraph_z <- lapply(PofficeStateList , FUN = Pplot_z)
do.call("grid.arrange" , c(Pgraph_z , ncol = 7))

Nplot_z <- function(state_put) {
    ggplot(data = neg_cand_state(state_put), aes(x = cand_party_affiliation, y = per_cand)) +
    theme_economist() +
    geom_bar(stat = "identity", aes(fill = cand_party_affiliation)) +
    theme(plot.title = element_text(size = 6) ,
          axis.text.x =  element_text(size = 6) ,
          axis.text.y = element_text(size = 6) ,
          legend.position = "none") +
    labs(x = "Party", y = "Total Dollars") + 
    ggtitle(paste(which(c(PofficeStateList) == state_put), ". " , state_put, sep = ""))
}
# These below do not have the titles

Ngraph_z <- lapply(NofficeStateList , FUN = Nplot_z)
do.call("grid.arrange" , c(Ngraph_z , ncol = 7))
```
