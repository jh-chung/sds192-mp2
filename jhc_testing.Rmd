---
title: "jhc_testing"
author: "Jay-Ho Chung"
date: "3/19/2018"
output: html_document
---

```{r, include=FALSE}
load("house_elections.rda")
load("candidates.rda")
load("committees.rda")
load("contributions.rda")
```

```{r}
library(tidyverse)
library(gridExtra)
library(dplyr)
library(ggplot2)
library(ggthemes)
```

```{r}
# Filtering out contributions that were against a candidate
negative_contributions <- contributions %>% 
  filter(transaction_type == "24A")

# Filtering out contributions that were for a candidate
positive_contributions <- contributions %>% 
  filter(transaction_type == "24E")

# Renaming a fec_id to cand_id for joining
h_elections <- house_elections %>% 
  rename(cand_id = fec_id)

# Finding candidates that were funded against
negative_candidates <- inner_join(negative_contributions, candidates, by = "cand_id") %>% 

  right_join(h_elections , by = "cand_id") %>% # Linking the candidates to their names, not just id number
  filter(!is.na(transaction_type)) %>% # Do not want NA transactions
  filter(!is.na(transaction_type)) %>% 
  group_by(cand_name, cand_party_affiliation, primary_votes,
           runoff_votes, general_votes, ge_winner) %>% 
  summarize(total_dollars = sum(transaction_amt)) %>% 
  arrange(desc(total_dollars))

positive_candidates <- inner_join(positive_contributions, candidates, by = "cand_id") %>% 
  right_join(h_elections, by = "cand_id") %>% 
  filter(!is.na(transaction_type)) %>% 
  group_by(cand_name, cand_party_affiliation, primary_votes,
  runoff_votes, general_votes, ge_winner) %>%
  summarize(total_dollars = sum(transaction_amt)) %>% 
  arrange(desc(total_dollars)) 


ggplot(positive_candidates, aes(x = general_votes,
                                y = total_dollars)) +
  geom_point(aes(col = ge_winner))

ggplot(negative_candidates, aes(x = general_votes,
                                y = total_dollars)) +
  geom_point(aes(col = ge_winner))
```

So a few things. First, connect with the contributions and candidates.

```{r}
cand_contributions <- contributions %>%
  full_join(candidates , by = "cand_id") %>%
  group_by(cand_id , cand_name , cand_office_state , cmte_id , transaction_amt , transaction_dt , transaction_pgi , transaction_type)

h_elections <- house_elections %>% 
  rename(cand_id = fec_id) 

hcand_contributions <- cand_contributions %>%
  full_join(h_elections , by = "cand_id") %>%
  select(cand_id , cand_name , cand_office_state , cand_party_affiliation , cand_office_district , cmte_id , transaction_amt , cand_election_yr , transaction_dt , transaction_pgi , transaction_type , entity_type , ge_winner) 


n_cobn <- hcand_contributions %>%
  select(cand_id , cand_name , cand_office_state , cand_party_affiliation , cand_office_district , cmte_id , transaction_amt , transaction_dt , transaction_pgi , transaction_type , entity_type) %>%
  filter(transaction_type == "24A")

p_cobn <- hcand_contributions %>%
  select(cand_id , cand_name , cand_office_state , cand_party_affiliation , cand_office_district , cmte_id , transaction_amt , transaction_dt , transaction_pgi , transaction_type , entity_type) %>%
  filter(transaction_type == "24E" )

# This is just to find how many elections there were in total: 445. Phew.
house_elections %>%
  group_by(state , district) %>%
  summarize( N = n()) %>%
  nrow()
```

```{r}
n_cobn1 <- n_cobn %>% 
  group_by(cand_name) %>% 
  summarize(total_amt = sum(transaction_amt))

p_cobn1 <- p_cobn %>% 
  group_by(cand_name) %>% 
  summarize(total_amt = sum(transaction_amt)) %>% 
  arrange(desc(total_amt))

```

```{r}
hcand_dollars <- hcand_contributions %>% 
  filter(!is.na(cand_party_affiliation)) %>% 
  filter(!is.na(transaction_amt)) %>% 
  group_by(cand_party_affiliation) %>% 
  summarize(total_donations = sum(transaction_amt),
            num_cand = n_distinct(candidate_name),
            per_cand = total_donations / num_cand) %>% 
  #filtered by certain parties but still  
  #doesn't look great on graph
  filter(cand_party_affiliation %in% c("DFL", "DEM", 
                                       "REP","IND"))
```

```{r}
hcand_wins <- hcand_contributions %>% 
  filter(!is.na(cand_party_affiliation), !is.na(ge_winner)) %>% 
  ungroup() %>% 
  select(cand_party_affiliation, candidate_name,
         ge_winner) %>% 
  group_by(candidate_name) %>% 
  unique() %>% 
  group_by(cand_party_affiliation) %>% 
  summarize(total = n_distinct(candidate_name), 
            wins = sum(ifelse(ge_winner == "W", 1, 0)),
            prop = wins/total)

hcand_wins1 <- hcand_wins %>% 
  #similarly filtered by only certain parties
  filter(cand_party_affiliation %in% c("DFL", "DEM", 
                                       "REP", "IND"))
```

These plots include information from joining together the contributions, candidates, and house_elections data sets. On the left, there is information about the success rate of the different parties in elections. On top of each of the bars on the chart is the total number of candidates from the data. So while the Minnesota Democratic-Farmer-Labor Party (or DFL) has a higher success rate than Democrats or Republicans, there were also fewer candidates from this party. The graph on the right shows the amount of donations per candidate separated by party. We were trying to see if there was any correlation between the success of party candidates and the amount of donations they received. One interesting thing that can be seen is that Democrats spent comparatively more than Republicans on each candidate, but had a very similar success rate in elections.

```{r}
library(ggplot2)
library(ggthemes)
library(gridExtra)
# basic plots showing success of parties in elections,
# as well as total donations received--not sure what we want to
# do here as only democrats and republicans receive much money
percent_plot <- ggplot(hcand_wins1, aes(x = cand_party_affiliation, y = prop)) +
  geom_bar(stat = "identity", aes(fill = cand_party_affiliation)) +
  labs(title = "Success Rate by Party", x = "Party", y = "Proportion of Wins in Elections") +
  theme_economist() + 
  theme(plot.title = element_text(size = 12),
        legend.position = "none") +
  geom_text(aes(label = total),
            position = position_dodge(width = 0.9),
            vjust = -0.25,
            size = 3)


money_plot <- ggplot(hcand_dollars, 
                     aes(x = cand_party_affiliation, 
                         y = per_cand)) +
  geom_bar(stat = "identity", aes(fill = cand_party_affiliation)) +
  labs(title = "Donations per Candidate",
       subtitle = "Separated by Party",
       x = "Party", y = "Total Dollars Donated") +
  theme_economist() +
  theme(plot.title = element_text(size = 12),
        legend.position = "none")
  # geom_text(aes(label=per_cand),
  #           position=position_dodge(width=0.9),
  #           vjust=-0.25,
  #           size = 2)
  

grid.arrange(percent_plot, money_plot, ncol = 2)
```

```{r not working}
n_money <- ggplot(n_cobn1 , aes(x = cand_party_affiliation , y = total_amt)) +
  geom_bar(stat = "identity") +
  labs(title = "Negative Contributions Spent Against Each Party" , 
       x = "Party" , y = "Negative Contributions") +
  theme_economist() +
  theme(plot.title = element_text(size = 12))

n_money
```

```{r Time Series test}
# Time series of how the proportion of positive:negative contributions has changed and how this, perhaps, has changed the wins
# Note that h_candcontributions has a cand_election_yr, which is discerte in this case.
# Iterate over each state?
cobn2 <- hcand_contributions %>%
  select(cand_id , cand_name , cand_office_state , cand_party_affiliation , cand_office_district , cmte_id , transaction_amt , cand_election_yr , transaction_dt , transaction_pgi , transaction_type , entity_type , ge_winner) %>%
  na.omit(ge_winner) %>%
  na.omit(cand_election_yr) %>% 
  group_by(cand_id , transaction_type , transaction_amt) %>%
  filter(transaction_type == "24A" || transaction_type == "24E") %>%
  summarize(t_t = sum(transaction_amt)) 
# So far, I have made t_t to find the total transaction for 24A and 24E.

  #mutate(n_c = t_t / sum(t_t)) %>%
  #filter(transaction_type == "24A")

d_cobn <- n_cobn2 %>%
  filter(cand_party_affiliation == "DEM")
# Here, checking the Dems contributions. Gives us total spent against Dems, resulting in Ws, and total sepent against 


# Just graph it first. group_by(year , transaction_amt) graph it. Separate and specify in 
p_cobn2 <- hcand_contributions %>%
  select(cand_id , cand_name , cand_office_state , cand_party_affiliation , cand_office_district , cmte_id , transaction_amt , cand_election_yr , transaction_dt , transaction_pgi , transaction_type , entity_type , ge_winner) %>%
  filter(transaction_type == "24E" , !is.na(ge_winner) , !is.na(cand_election_yr)) %>%
  group_by(cand_id , cand_election_yr , transaction_type , cand_party_affiliation) %>%
  summarize(p_c = sum(transaction_amt))



rn_cobn <- n_cobn2 %>%
  full_join(p_cobn , by = "cand_id") %>%
  filter(cand_party_affiliation == "REP") %>%
  mutate(p_n = p_c / n_c)


n_cobn2 <- hcand_contributions %>%
    filter(transaction_type == "24A" || transaction_type == "24E") %>%
    na.omit(ge_winner) %>%
    na.omit(cand_election_yr) %>% 
    group_by(cand_election_yr , ge_winner , cand_party_affiliation) %>%
    summarize(t_t = sum(transaction_amt))



  
n_p_plot <- ggplot(n_cobn2 , aes(x = cand_election_yr , y = ge_winner)) +
  geom_bar(aes(x = cand_election_yr))

n_p_plot
```


```{r}
hcand_dollars <- hcand_contributions %>% 
  filter(!is.na(cand_party_affiliation)) %>% 
  filter(!is.na(transaction_amt)) %>% 
  group_by(cand_party_affiliation) %>% 
  summarize(total_donations = sum(transaction_amt),
            num_cand = n_distinct(candidate_name),
            per_cand = total_donations / num_cand) %>% 
  #filtered by certain parties but still  
  #doesn't look great on graph
  filter(cand_party_affiliation %in% c("DFL", "DEM", 
                                       "REP","IND"))
```

```{r}
hcand_wins <- hcand_contributions %>% 
  filter(!is.na(cand_party_affiliation), !is.na(ge_winner)) %>% 
  ungroup() %>% 
  select(cand_party_affiliation, candidate_name,
         ge_winner) %>% 
  group_by(candidate_name) %>% 
  unique() %>% 
  group_by(cand_party_affiliation) %>% 
  summarize(total = n_distinct(candidate_name), 
            wins = sum(ifelse(ge_winner == "W", 1, 0)),
            prop = wins/total)

hcand_wins1 <- hcand_wins %>% 
  #similarly filtered by only certain parties
  filter(cand_party_affiliation %in% c("DFL", "DEM", 
                                       "REP", "IND"))
```

```{r}
pos_cand_dollars <- hcand_dollars %>% 
  filter(transaction_type == "24E") %>%
  filter(!is.na(cand_party_affiliation)) %>% 
  filter(!is.na(transaction_amt)) %>% 
  group_by(cand_party_affiliation) %>% 
  mutate(total_donations = sum(transaction_amt),
            num_cand = n_distinct(candidate_name),
            per_cand = total_donations / num_cand) %>%
  filter(cand_party_affiliation %in% c("DFL", "DEM", 
                                       "REP","IND"))

neg_cand_dollars <- hcand_dollars %>% 
  filter(transaction_type == "24A") %>%
  filter(!is.na(cand_party_affiliation)) %>% 
  filter(!is.na(transaction_amt)) %>% 
  group_by(cand_party_affiliation) %>% 
  mutate(total_donations = sum(transaction_amt),
            num_cand = n_distinct(candidate_name),
            per_cand = total_donations / num_cand) %>%
  filter(cand_party_affiliation %in% c("DFL", "DEM", 
                                       "REP","IND"))
```

